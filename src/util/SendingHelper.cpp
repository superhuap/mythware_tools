// SendingHelper.cpp
#include "SendingHelper.h"
#include <array>
#include <ElaMessageBar.h>
#include <QtNetwork/QUdpSocket>
#include <QRandomGenerator>
#include "SettingManager.h"

SendingHelper* SendingHelper::m_instance = nullptr;

SendingHelper* SendingHelper::instance()
{
    if (!m_instance) {
        m_instance = new SendingHelper();
    }
    return m_instance;
}

SendingHelper::SendingHelper(QObject* parent)
        : QObject(parent)
{
}

static const char* BASE0_HEX =
        "444d4f43000001009e0300001041affba0e7524091dc27a3b6f9292e204e0000c0a85081910300009103000000080000000000000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";

static const char* BASE1_HEX =
        "444d4f43000001006e0300005b682b256f61644da792f04700c5a40e204e0000c0a86486610300006103000000020000000000000f0000000100000043003a005c00570069006e0064006f00770073005c00730079007300740065006d00330032005c0063006d0064002e0065007800650000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002f006300200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000001000000000000000000";

static const char* BASE2_HEX =
        "444d4f43000001006e0300005b682b256f61644da792f04700c5a40e204e0000c0a86486610300006103000000020000000000000f0000000100000043003a005c00570069006e0064006f00770073005c00730079007300740065006d00330032005c00570069006e0064006f007700730050006f007700650072005300680065006c006c005c00760031002e0030005c0070006f007700650072007300680065006c006c002e0065007800650000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002f006300200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000001000000000000000000";

const std::array<QByteArray, 3> SendingHelper::m_base = {
        QByteArray::fromHex(BASE0_HEX),
        QByteArray::fromHex(BASE1_HEX),
        QByteArray::fromHex(BASE2_HEX)
};

QByteArray SendingHelper::formatToBytes(const QString& text) const
{
    QByteArray result;
    for (QChar ch : text) {
        ushort code = ch.unicode();
        result.append(static_cast<char>(code & 0xFF));        // 低字节
        result.append(static_cast<char>((code >> 8) & 0xFF)); // 高字节
    }
    return result;
}

QByteArray SendingHelper::packMessage(const QString& type, QString& content) const
{
    QByteArray packet;

    if (type == "msg") {
        packet = m_base[0];
        QByteArray data = formatToBytes(content);
        int index = 56;
        for (char byte : data) {
            if (index < packet.size()) {
                packet[index] = static_cast<unsigned char>(byte);
                index++;
            }
        }
    }
    else if (type == "cmd") {
        packet = m_base[1];
        content = content.replace("\n", "&");
        QByteArray data = formatToBytes(content);
        int index = 578;
        for (char byte : data) {
            if (index < packet.size()) {
                packet[index] = static_cast<unsigned char>(byte);
                index++;
            }
        }
    }
    else if (type == "powershell") {
        packet = m_base[2];
        content = content.replace("\n", ";");
        QByteArray data = formatToBytes(content);
        int index = 578;
        for (char byte : data) {
            if (index < packet.size()) {
                packet[index] = static_cast<unsigned char>(byte);
                index++;
            }
        }
    }
    for (int i = 0; i < 5; ++i) {
        packet[15 + i] = static_cast<char>(QRandomGenerator::global()->bounded(256));
    }

    return packet;
}

void SendingHelper::send(const QString& type, QString content, const QString& ip)
{
    QByteArray datagram = packMessage(type, content);
    QUdpSocket socket;
    socket.writeDatagram(datagram, QHostAddress(ip), SettingsManager::instance()->getValue("port").toUInt());
}